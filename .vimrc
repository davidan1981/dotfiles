"
"  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
" ▐░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▌
"  ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
"     ▄               ▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄       ▄▄  ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄
"    ▐░▌             ▐░▌▐░░░░░░░░░░░▌▐░░▌     ▐░░▌▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌
"     ▐░▌           ▐░▌  ▀▀▀▀█░█▀▀▀▀ ▐░▌░▌   ▐░▐░▌▐░█▀▀▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀▀▀
"      ▐░▌         ▐░▌       ▐░▌     ▐░▌▐░▌ ▐░▌▐░▌▐░▌       ▐░▌▐░▌
"       ▐░▌       ▐░▌        ▐░▌     ▐░▌ ▐░▐░▌ ▐░▌▐░█▄▄▄▄▄▄▄█░▌▐░▌
"        ▐░▌     ▐░▌         ▐░▌     ▐░▌  ▐░▌  ▐░▌▐░░░░░░░░░░░▌▐░▌
"         ▐░▌   ▐░▌          ▐░▌     ▐░▌   ▀   ▐░▌▐░█▀▀▀▀█░█▀▀ ▐░▌
"          ▐░▌ ▐░▌           ▐░▌     ▐░▌       ▐░▌▐░▌     ▐░▌  ▐░▌
"           ▐░▐░▌        ▄▄▄▄█░█▄▄▄▄ ▐░▌       ▐░▌▐░▌      ▐░▌ ▐░█▄▄▄▄▄▄▄▄▄
"            ▐░▌        ▐░░░░░░░░░░░▌▐░▌       ▐░▌▐░▌       ▐░▌▐░░░░░░░░░░░▌
"             ▀          ▀▀▀▀▀▀▀▀▀▀▀  ▀         ▀  ▀         ▀  ▀▀▀▀▀▀▀▀▀▀▀
"  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
" ▐░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▌
"  ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀
"
"  This script uses vim-plug to install plug-ins. 
"    * night-owl
"    * nerdtree
"    * vim-flake8
"
"  To reload this resource file, do <leader>sv which is mapped to 
"    :so $MYVIMRC.
"
"  Use 'z' for navigation. For example, zt for a new tab zq to close it.
"  Use 'jj' or 'jk' to get out of insert mode. Try best not to use esc.
"
"  Good luck.
"
"  ▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄
" ▐░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░▌
"  ▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀▀

" vim-plug
let data_dir = has('nvim') ? stdpath('data') . '/site' : '~/.vim'
if empty(glob(data_dir . '/autoload/plug.vim'))
  silent execute '!curl -fLo '.data_dir.'/autoload/plug.vim --create-dirs  https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
  autocmd VimEnter * PlugInstall --sync | source $MYVIMRC
endif
call plug#begin('~/.vim/plugged')
Plug 'haishanh/night-owl.vim'
Plug 'preservim/nerdtree'
Plug 'https://github.com/nvie/vim-flake8.git'
call plug#end()

" this will make plugins recognizable easily
execute pathogen#infect() 

" Functions

fun! TrimWhitespace()
    " Trim whitespace at the end of each line
    let l:save_cursor = getpos('.')
    %s/\s\+$//e
    call setpos('.', l:save_cursor)
endfun

fun! ForceCloseTab()
    " Close nerdtree before closing a tab
    NERDTreeClose
    quit
endfun

" Basic configurations
syntax on
filetype on
filetype plugin on
set path+=**
set wildmenu
set enc=utf-8
set backspace=2
set laststatus=2
set statusline=%F\ %y:\ %l,%v\ of\ %L\ lines
set history=50
set tabstop=2
set shiftwidth=2
set expandtab
set smartindent
set autoindent
set textwidth=120  " be modern
set incsearch
set hlsearch
set title
set number
set mouse=a
set fillchars=vert:\ 
set pastetoggle=<F2>
let g:vim_markdown_folding_disabled=1

" Leaders
let mapleader=","
let maplocalleader=","  

" Key mappings

" Next tab
nnoremap <Right>    :tabn<CR>
nnoremap z<Right>     :tabn<CR>
nnoremap zl           :tabn<CR>

" Previous tab
nnoremap <Left>     :tabp<CR>
nnoremap z<Left>      :tabp<CR>
nnoremap zh           :tabp<CR>

" New tab
nnoremap zt           :tabnew<CR>

" Close with a confirmation
nnoremap zw           :confirm bdelete<CR>

" Close tab ignoring Nerdtree
nnoremap zq           :call ForceCloseTab()<CR>
nnoremap <leader>q    :call ForceCloseTab()<CR>

" Splits
nnoremap <leader>ev   :vsplit $MYVIMRC<CR>
nnoremap <leader>sv   :source $MYVIMRC<CR>

" Quotes
nnoremap <leader>"    viw<esc>a"<esc>hbi"<esc>lel
nnoremap <leader>'    viw<esc>a'<esc>hbi'<esc>lel

" Spelling checks
nnoremap <leader>p    :set spell spelllang=en_us<CR>
nnoremap <leader>P    :set nospell<CR>

" ??
inoremap #            X<c-h>#

" Other navigations
inoremap jk           <esc>
inoremap jj           <esc>

" Saving
inoremap jwj          <esc>:w<CR>
inoremap jwk          <esc>:w<CR>

" Viaual mode stuff
vnoremap //           y/<c-r>"<CR>
vnoremap <leader>"    <esc>`<i"<esc>`>a"<esc>
vnoremap <leader>'    <esc>`<i'<esc>`>a'<esc>

" Copy paste
if has('macunix')
    vnoremap zc           <esc>:'<,'>w !pbcopy<CR>
endif
if has('linux')
    vnoremap zc           <esc>:'<,'>w !xclip -i -sel c<CR>
endif
nnoremap zv           :set paste<CR>:r !pbpaste<CR>:set nopaste<CR>

" Autocorrect
iabbrev  adn          and
iabbrev  waht         what
iabbrev  tehn         then
iabbrev  tempalte     template
iabbrev  acount       account
iabbrev  accuont      account
iabbrev  Acount       Account
iabbrev  Accuont      Account
iabbrev  qury         query
iabbrev  qeury        query
iabbrev  verison      version
iabbrev  uesr         user
iabbrev  fucn         func
iabbrev  destory      destroy

" Turn off annoying keys. any better way to do this?
nnoremap <esc>j       <nop>
nnoremap <esc>k       <nop>
nnoremap <esc>h       <nop>
nnoremap <esc>l       <nop>
nnoremap <esc>i       <nop>
nnoremap <esc>a       <nop>
nnoremap <esc>,       <nop>
nnoremap <esc>z       <nop>
nnoremap <esc>w       <nop>
nnoremap <esc>v       <nop>
nnoremap <esc><CR>    <nop>
nnoremap <esc><space> <nop>

" Terminal vs. GUI
if (has("termguicolors"))
  " I just like having GUI vim possibly with a different theme.
  set termguicolors
endif

" Theme-related
let &t_ZH="\e[3m"  " allows italics
let &t_ZR="\e[23m"  " allows italics
colorscheme night-owl
let g:lightline = { 'colorscheme': 'nightowl' }
let python_highlight_all=1

" NERDTree
let NERDTreeStatusline="."
" let g:NERDTreeDirArrows=0 " uncomment when no support for unicode
let NERDTreeIgnore = ['\.pyc$']
nnoremap <F10>     :NERDTreeToggle<CR>
nnoremap <leader>f :NERDTreeToggle<CR>
nnoremap <leader>g :wincmd w<CR>
nnoremap zf        :NERDTreeToggle<CR>:wincmd p<CR>
" Open the existing NERDTree on each new tab.
autocmd BufWinEnter * if getcmdwintype() == '' | silent NERDTreeMirror | endif

" Ctags
" You must run ctags -R -o ~/tags ~/src
" let Tlist_GainFocus_On_ToggleOpen = 1
" let Tlist_Close_On_Select = 1
" let Tlist_Use_Right_Window = 1
" let Tlist_File_Fold_Auto_Close = 1
" set tags=tags;$HOME/.vim/tags/
" nnoremap <F9> :TlistToggle<CR>
" nnoremap <C-\> :tab split<CR>:exec("tag ".expand("<cword>"))<CR>
" nnoremap <C-[> :pop<CR>
" autocmd bufenter * if (winnr("$") == 1 && exists("s:displayed_warnings")) | q | endif

" File type-specific auto commands
augroup filetype_md
    autocmd!
    autocmd BufNewFile,BufReadPost *.md setlocal filetype=ghmarkdown
augroup END
augroup filetype_ocaml
    autocmd!
    autocmd FileType     ocaml,omake     setlocal tabstop=8 shiftwidth=8
augroup END
augroup filetype_ruby
    autocmd!
    autocmd FileType     ruby        nnoremap <buffer> <localleader>c I# <esc>
    autocmd FileType     ruby        nnoremap <buffer> <localleader>u I<esc>lxx
    autocmd BufWritePre  *.rb        call TrimWhitespace()
augroup END
augroup filetype_html
    autocmd!
    autocmd FileType     html        setlocal textwidth=255
    autocmd BufWritePre  html        call TrimWhitespace()
augroup END
augroup filetype_js
    autocmd!
    autocmd FileType     javascript  nnoremap <buffer> <localleader>c I// <esc>
    autocmd FileType     javascript  nnoremap <buffer> <localleader>u I<esc>lxxx
    autocmd FileType     javascript  setlocal tabstop=2 shiftwidth=2
    autocmd BufWritePre  javascript  call TrimWhitespace()
    autocmd BufWritePre  *.js  call TrimWhitespace()
augroup END
augroup filetype_vim
    autocmd!
    autocmd FileType     vim,conf    setlocal tabstop=4 shiftwidth=4
augroup END
augroup filetype_python
    autocmd!
    autocmd FileType     python      setlocal tabstop=4 shiftwidth=4
    autocmd FileType     python      nnoremap <buffer> <localleader>c I# <esc>
    autocmd FileType     python      nnoremap <buffer> <localleader>u I<esc>lxx
    autocmd FileType     python      iabbrev <buffer> iff if:<CR>pass<up><left>
    autocmd BufWritePost *.py        call Flake8()
    autocmd BufUnload    *.py        cclose
    autocmd ColorScheme  python      highlight ExtraWhitespace ctermbg=red guibg=red
    autocmd BufWinEnter  python      match ExtraWhitespace /\s\+$/
    autocmd InsertEnter  python      match ExtraWhitespace /\s\+\%# \@<!$/
    autocmd InsertLeave  python      match ExtraWhitespace /\s\+$/
    autocmd BufWritePre  *.py        call TrimWhitespace()
augroup END
augroup filetype_make
    autocmd!
    autocmd FileType     make        setlocal noexpandtab
augroup END
augroup filetype_go
    autocmd!
    autocmd FileType     go          setlocal tabstop=4 shiftwidth=4
    autocmd BufWritePre  *.go        call TrimWhitespace()
augroup END
